# Docker Compose for DealPulse - Traefik Infrastructure Standard
# =============================================================================
# IMPORTANT: This setup follows the dev/infra standards:
# - No direct port binding (except Traefik owns 80/443)
# - All routing via Traefik hostnames
# - App runs on host with `npm run dev`, not containerized
#
# Required /etc/hosts entries:
#   127.0.0.1 dealpulse.local
#   127.0.0.1 api.dealpulse.local
#   127.0.0.1 studio.dealpulse.local
#
# Start: docker compose up -d
# Dev:   npm run dev -- -p 3011 (separate terminal)
# =============================================================================

networks:
  traefik_net:
    external: true
  dealpulse_net:
    name: dealpulse_net

volumes:
  dealpulse_db_data:
  dealpulse_storage_data:
  dealpulse_redis_data:

services:
  # -------------------------
  # Supabase API Gateway (Kong)
  # -------------------------
  kong:
    image: kong:2.8.1
    container_name: dealpulse-kong
    networks:
      - dealpulse_net
      - traefik_net
    restart: unless-stopped
    expose:
      - "8000"
      - "8443"
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_PLUGINS: request-transformer,cors,key-auth,acl
    volumes:
      - ./supabase/volumes/api/kong.yml:/var/lib/kong/kong.yml
    depends_on:
      - auth
      - rest
      - realtime
      - storage
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dealpulse-api.rule=Host(`api.dealpulse.local`)"
      - "traefik.http.routers.dealpulse-api.entrypoints=web"
      - "traefik.http.services.dealpulse-api.loadbalancer.server.port=8000"
      - "traefik.docker.network=traefik_net"

  # -------------------------
  # PostgreSQL Database (NO HOST PORTS)
  # -------------------------
  db:
    image: supabase/postgres:15.1.1.2
    container_name: dealpulse-db
    networks:
      - dealpulse_net
    expose:
      - "5432"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXP: 3600
    volumes:
      - dealpulse_db_data:/var/lib/postgresql/data
      - ./supabase/migrations:/docker-entrypoint-initdb.d/mna-migrations:ro
      - ./supabase/docker-init/00-configure-auth.sh:/docker-entrypoint-initdb.d/00-configure-auth.sh:ro

  # -------------------------
  # Supabase Studio (Dashboard)
  # -------------------------
  studio:
    image: supabase/studio:latest
    container_name: dealpulse-studio
    networks:
      - dealpulse_net
      - traefik_net
    restart: unless-stopped
    expose:
      - "3000"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --spider --tries=1 --timeout=5 http://localhost:3000/api/profile || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      STUDIO_PG_META_URL: http://meta:8080
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SUPABASE_URL: http://kong:8000
      SUPABASE_PUBLIC_URL: http://api.dealpulse.local
      SUPABASE_ANON_KEY: ${ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SERVICE_ROLE_KEY}
    depends_on:
      db:
        condition: service_healthy
      meta:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dealpulse-studio.rule=Host(`studio.dealpulse.local`)"
      - "traefik.http.routers.dealpulse-studio.entrypoints=web"
      - "traefik.http.services.dealpulse-studio.loadbalancer.server.port=3000"
      - "traefik.docker.network=traefik_net"

  # -------------------------
  # GoTrue (Auth)
  # -------------------------
  auth:
    image: supabase/gotrue:v2.132.3
    container_name: dealpulse-auth
    networks:
      - dealpulse_net
    env_file:
      - .env
    expose:
      - "9999"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --spider --tries=1 --timeout=5 http://localhost:9999/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: http://api.dealpulse.local
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgres://supabase_auth_admin:${POSTGRES_PASSWORD}@db:5432/postgres
      GOTRUE_SITE_URL: http://dealpulse.local
      GOTRUE_URI_ALLOW_LIST: "*"
      GOTRUE_JWT_SECRET: ${JWT_SECRET}
      GOTRUE_JWT_EXP: 3600
      GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
      GOTRUE_EXTERNAL_EMAIL_ENABLED: "true"
      GOTRUE_MAILER_AUTOCONFIRM: "true"
      # Google OAuth for user sign-in
      GOTRUE_EXTERNAL_GOOGLE_ENABLED: "true"
      GOTRUE_EXTERNAL_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOTRUE_EXTERNAL_GOOGLE_SECRET: ${GOOGLE_CLIENT_SECRET}
      # Google OAuth requires localhost (doesn't allow .local domains)
      GOTRUE_EXTERNAL_GOOGLE_REDIRECT_URI: http://localhost/auth/v1/callback
    depends_on:
      db:
        condition: service_healthy

  # -------------------------
  # PostgREST (API)
  # -------------------------
  rest:
    image: postgrest/postgrest:v12.0.2
    container_name: dealpulse-rest
    networks:
      - dealpulse_net
    env_file:
      - .env
    expose:
      - "3000"
    environment:
      PGRST_DB_URI: postgres://authenticator:${POSTGRES_PASSWORD}@db:5432/postgres
      PGRST_DB_SCHEMAS: public,storage,graphql_public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_USE_LEGACY_GUCS: "false"
    depends_on:
      db:
        condition: service_healthy

  # -------------------------
  # Realtime
  # -------------------------
  realtime:
    image: supabase/realtime:v2.25.22
    container_name: dealpulse-realtime
    networks:
      - dealpulse_net
    env_file:
      - .env
    expose:
      - "4000"
    environment:
      PORT: 4000
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: supabase_admin
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: postgres
      DB_SSL: "false"
      SLOT_NAME: supabase_realtime_rls
      JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY_BASE: ${JWT_SECRET}
    depends_on:
      db:
        condition: service_healthy

  # -------------------------
  # Storage
  # -------------------------
  storage:
    image: supabase/storage-api:v1.0.3
    container_name: dealpulse-storage
    networks:
      - dealpulse_net
    env_file:
      - .env
    expose:
      - "5000"
    environment:
      ANON_KEY: ${ANON_KEY}
      SERVICE_KEY: ${SERVICE_ROLE_KEY}
      POSTGREST_URL: http://rest:3000
      PGRST_JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgres://supabase_storage_admin:${POSTGRES_PASSWORD}@db:5432/postgres
      FILE_SIZE_LIMIT: 52428800
      STORAGE_BACKEND: file
      FILE_STORAGE_BACKEND_PATH: /var/lib/storage
      TENANT_ID: stub
      REGION: stub
      GLOBAL_S3_BUCKET: stub
    volumes:
      - dealpulse_storage_data:/var/lib/storage
    depends_on:
      db:
        condition: service_healthy

  # -------------------------
  # Meta (Postgres Management API)
  # -------------------------
  meta:
    image: supabase/postgres-meta:v0.80.0
    container_name: dealpulse-meta
    networks:
      - dealpulse_net
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      PG_META_PORT: 8080
      PG_META_DB_HOST: db
      PG_META_DB_PASSWORD: ${POSTGRES_PASSWORD}
    depends_on:
      db:
        condition: service_healthy

  # -------------------------
  # Redis (Job Queue) - Internal only
  # -------------------------
  redis:
    image: redis:7-alpine
    container_name: dealpulse-redis
    networks:
      - dealpulse_net
    restart: unless-stopped
    expose:
      - "6379"
    volumes:
      - dealpulse_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -------------------------
  # Background Workers
  # -------------------------
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dealpulse-worker
    networks:
      - dealpulse_net
    command: npm run worker
    env_file:
      - .env
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      NODE_ENV: development
      # Internal URLs for Docker-to-Docker communication
      SUPABASE_INTERNAL_URL: http://kong:8000
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./workers
          target: /app/workers
        - action: sync
          path: ./lib
          target: /app/lib
        - action: rebuild
          path: package.json
